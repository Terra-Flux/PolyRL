FROM nvcr.io/nvidia/pytorch:25.05-py3

SHELL ["/bin/bash", "-lc"]

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PATH="/opt/venv/bin:${PATH}"

WORKDIR /workspace/polyrl

# Copy the local workspace into the image
COPY . .

# System deps and Python installer tooling (no Rust needed for rollout engines)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        curl \
        git \
        ninja-build \
        numactl \
        python3-dev \
        python3-venv && \
    rm -rf /var/lib/apt/lists/*

# Python dependencies (uv, sglang, flash-attn, PolyRL)
RUN python3 -m venv /opt/venv && \
    /opt/venv/bin/pip install --no-cache-dir --upgrade pip uv && \
    uv pip install cmake && \
    uv pip install sglang==0.5.5 && \
    uv pip install flash-attn --no-build-isolation && \
    uv pip install -e .

CMD ["/bin/bash"]
