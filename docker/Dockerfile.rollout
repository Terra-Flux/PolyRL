FROM nvcr.io/nvidia/cuda:12.8.0-cudnn-devel-ubuntu24.04

SHELL ["/bin/bash", "-lc"]

ENV DEBIAN_FRONTEND=noninteractive \
    PATH="/opt/venv/bin:/root/.cargo/bin:${PATH}"

WORKDIR /workspace/polyrl

# Copy the local workspace into the image
COPY . .

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    ninja-build \
    numactl && \
    rm -rf /var/lib/apt/lists/*

# Install Rust (needed for some deps like tiktoken/tokenizers if they build from source, or specific PolyRL parts)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# Install uv
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv

# Setup venv and install dependencies
RUN uv venv /opt/venv --python 3.12 && \
    uv pip install cmake && \
    uv pip install sglang==0.5.5 && \
    uv pip install flash-attn --no-build-isolation && \
    cd /workspace/polyrl && uv pip install -e .

CMD ["/bin/bash"]
